#
# Picks up docker image from hub.docker.com as repository.
#
# Pulls without login (public repository only).
# Requires username/repository to match the github repository.
# For example: nerdvegas/rez -> User/Repository: nerdvegas
#

name: windows

on:
  pull_request:
    paths-ignore:
      - '.github/docker/**'
      - '.github/workflows/windows-docker-image.yaml'
      - 'src/rez/utils/_version.py'
      - 'wiki/**'
      - 'metrics/**'
      - '**.md'
  push:
    paths-ignore:
      - '.github/docker/**'
      - '.github/workflows/windows-docker-image.yaml'
      - 'src/rez/utils/_version.py'
      - 'wiki/**'
      - 'metrics/**'
      - '**.md'

jobs:
  main:
    runs-on: windows-2019

    strategy:
      matrix:
        # Needs to match python version of images (see windows-docker-image.yaml)
        python-version:
          - '2.7.17'
          # TODO add back once failing windows py3 builds are investigated
          #- '3.7.5'
      fail-fast: false

    steps:

      - name: Checkout
        uses: actions/checkout@v2

      - name: Run Docker image (installs and tests rez)
        run: |
          ${docker_image} = "nerdvegas/rez-win-py-${{ matrix.python-version }}"

          Write-Output "Pulling latest DockerHub image ${docker_image}..."
          docker pull ${docker_image}

          Write-Output "Running DockerHub image ${docker_image}..."
          docker run --mount type=bind,src=$pwd,dst=C:\checkout,readonly ${docker_image}
